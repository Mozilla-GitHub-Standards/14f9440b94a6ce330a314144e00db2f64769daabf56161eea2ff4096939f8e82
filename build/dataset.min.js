!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.dataset=t.dataset||{})}(this,function(t){"use strict";function e(t,e){t.data[e]={indexed:!1},t.data[e].namespace=e,t.data[e].promise=Promise.resolve({dataset:t.data[e],dashboard:t}),t.last_ns=e}function n(t,e){if("object"==typeof e){var n=e.namespace,a=e.hasOwnProperty("csv")?r(d3.csv,e.csv):r(d3.json,e.json),s=i(e.format);t.data[n].promise=t.data[n].promise.then(a).then(s),t.data[n].promise=e.hasOwnProperty("index")?t.data[n].promise.then(db_index(e.index)):t.data[n].promise}}function a(t,e){t.data[t.last_ns].promise=t.data[t.last_ns].promise.then(e)}function s(t){return function(e){return new Promise(function(n,a){t(e.dataset,e.dashboard),n(e)})}}function r(t,e){return function(n){return new Promise(function(a,s){t(e,function(t){n.dataset.data=t,n.dataset.path=e,a(n)})})}}function i(t){return function(e){return new Promise(function(n,a){e.dataset.data=t(e.dataset.data,e.dashboard),n(e)})}}function o(){this.data={},this.values={},this.segments={};return this.first_load_fcn=!1,this.data_cuts=[],this.use_steps=[],this.with=function(t,e){this.last_ns=t;var n=this;a(n,s(e))},this.hasDataset=function(t){return this.data.hasOwnProperty(t)},this.value=function(){return 1==arguments.length?this.values[arguments[0]]:2==arguments.length?(this.values[arguments[0]]=arguments[1],this):this},this.onFirstLoad=function(t){return this.first_load_fcn=t,this},this.then=function(t){var e=this;return a(e,s(t)),this},this.fetchCSV=function(t){var e=this;return a(e,r(d3.csv,t)),this},this.fetchJSON=function(t){var e=this;return a(e,r(d3.json,t)),this},this.fetchText=function(t){var e=this;return a(e,r(d3.text,t)),this},this.format=function(t){var e=this;return a(e,i(t)),this},this.dataset=function(t){var a,s=this;return"string"==typeof t?a=t:"object"==typeof t&&(a=t.namespace),e(s,a),n(s,t),this},this.waitFor=function(t){var e=this,n=e.data[t].promise;return e.data[e.last_ns].promise=Promise.all([e.data[e.last_ns].promise,n]).then(function(){return{dataset:e.data[e.last_ns],dashboard:e}}),this},this.waitForAllThen=function(t){var e=this,n=Object.keys(e.data).map(function(t){return e.data[t].promise});Promise.all(n).then(function(){t(e)})},this}function u(t){return function(e){return new Promise(function(n,a){e.dataset.data=crossfilter(e.dataset.data),e.dataset.dims={},e.dataset.indexed=!0;for(var s,r=0;r<t.length;r++)s=t[r],e.dataset.dims[s]=e.dataset.data.dimension(function(t){return t[s]});n(e)})}}function d(t){var e={};return Object.keys(t.data).forEach(function(n){t.data[n].indexed&&(e[t.data[n].namespace]=t.data[n])}),e}function c(t){var e=this;return e.args_for_this=t,this.current_cut_step=Promise.all(Object.keys(e.data).map(function(t){return e.data[t].promise})).then(function(){return t}).then(function(t){var n,a=e,s="actives",r=d(a);a.segment("dataset");if("object"==typeof t&&null!==t)Object.keys(a.segments).forEach(function(e){t[e]=t.hasOwnProperty(e)?t[e]:a.segments[e]}),n=t.dataset?t.dataset:a.segment("dataset")?a.segment("dataset"):Object.keys(a.data).filter(function(t){return a.data[t].indexed}).map(function(t){return a.data[t].namespace});else{var t={};Object.keys(a.segments).forEach(function(e){t[e]=a.segments[e]}),n=a.segment("dataset")?a.segment("dataset"):Object.keys(a.data).filter(function(t){return a.data[t].indexed}).map(function(t){return a.data[t].namespace})}var i,o=[];return Array.isArray(n)||(n=[n]),n.forEach(function(e){Object.keys(t).forEach(function(t){"dataset"!=t&&r[e].dims[t].filterAll()}),Object.keys(t).forEach(function(n){"dataset"!=n&&r[e].dims[n].filter(t[n])}),i=r[e].dims[s].top(1/0),o.push(i)}),a.datasets_for=n,a.latest_data=o,o}),this}function f(t){var e=this;return t?Array.isArray(t)?(t.forEach(function(t){e.segments.hasOwnProperty(t)||(e.segments[t]=null)}),e):"object"==typeof t&&null!==t?(Object.keys(t).forEach(function(n){e.segments[n]=t[n]}),e):0==arguments.length?this.segments:1==arguments.length?e.segments[arguments[0]]:2==arguments.length?(e.segments[arguments[0]]=arguments[1],e):e:e.segments}function h(t){var e=this;return db_then(e,u(t)),this}function m(t){var e=this;e.current_cut_step.then(function(n){t(n,e)});return this}function p(){return new o}o.prototype.useData=m,o.prototype.index=h,o.prototype.segment=f,o.prototype.cutData=c;var l="0.1.0a";t.collection=p,t.version=l,Object.defineProperty(t,"__esModule",{value:!0})});